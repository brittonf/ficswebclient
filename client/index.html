<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
    <script src="chessboardjs-0.3.0/js/chessboard-0.3.0.min.js"></script>
    <script src="js/ficsparser.js"></script>
    <script src="js/movesparser.js"></script>
    <script src="js/game.js"></script>
    <link rel="stylesheet" href="chessboardjs-0.3.0/css/chessboard-0.3.0.min.css" />

<style>
html, body {
    margin:0;
    padding:0;
    font-size:14px;
    color: #0f0f0f;
    font-family: 'Open Sans', sans-serif;
}

.clearfix:after {
   content: " "; /* Older browser do not support empty content */
   visibility: hidden;
   display: block;
   height: 0;
   clear: both;
}

.wrapper {
    width:100%;
    max-width:1024px;
    margin:auto;
}

#header {
    height:55px;
    background-color:#3f6fff;
    padding-left:15px;
    border-bottom: 1px solid #0033ce;
    box-sizing:border-box;
}

#logo {
    position:relative;
    height:100%;
    color:#fff;
    font-size:24px;
    font-weight:300;
    display:inline-block;
    line-height:55px;

}

.observe {
    border:1px solid black;
    box-sizing:border-box;
    padding: 0 10px;
    display:block;
}

.observe .board {
    width:400px;
    display:inline-block;
}

.observe .game_info_container {
    height:100%;
    max-height:400px;
    margin-left:10px;
	display:inline-block;
	float:left;
}

.observe .game_info {
    display:inline-block;
    border:1px solid black;
    box-sizing:border-box;
    align-items: stretch;
    padding: 0 10px;
    max-width: 250px;
}


.player_name {
    box-sizing:border-box;
    padding:10px;
	display:block;
}

.top_time {
    position:relative;
    top:0;
    font-size:32px;
    line-height:50px;
}

.bottom_time {
    position:relative;
    bottom:0;
    font-size:32px;
    line-height:50px;
}

.board_info_container {
    display:inline-block;
    max-height:400px;
	float:left;
}

.move_list {
    border: 1px solid black;
    box-sizing:border-box;
    overflow: auto;
    position: relative;
    will-change: scroll-position;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    display: flex;
    flex-flow: row wrap;
    align-content: flex-start;
    max-height:200px;
}

.move_number {
    display: flex;
    flex: 0 0 15%;
    max-width: 15%;
    line-height: 27px;
    background: #e6e6e6;
    justify-content: center;
    height: 25px;
}

.move {
    flex: 0 0 42.5%;
    max-width: 42.5%;
    box-sizing: border-box;
    font-family: 'ChessSansPiratf',sans-serif;
    font-size: 17px;
    padding-left: 7px;
	height: 25px;
	line-height: 25px;
}
</style>
    <script>
        $(document).ready(function(){
            //#define BLK_GAMES 43
            //#define BLK_MOVES 77
            //#define BLK_OBSERVE 80
            //#define BLK_UNOBSERVE 138
            //#define BLK_SOUGHT 157

            $('#shellout').hide();
            $('#shellin').hide();

            $('#games').prop('disabled', true);
            $('#sought').prop('disabled', true);

            $('#games').on('click', function(e) {
                socket.emit('command', '1 games');
            });

            $('#sought').on('click', function(e) {
                socket.emit('command', '2 sought');
            });

            $('#login').keypress(function(e) {if (e.which == 13) login()});
            $('#password').keypress(function(e) {if (e.which == 13) login()});
            $('#login_button').on('click', function() { login() });


            $('#shellin').keypress(function(e) {
                    if (e.which == 13) {
                        socket.emit('command', '666 ' + $('#shell').val());
                        $('#shell').val('');
                    }
            });

			function getBottomPlayer(obj) {
				console.log(obj);
				if (obj.top_player == 'w') {
					bottom_player = 'b';
				}
				else {
					bottom_player = 'w';
				}
				return bottom_player;
			}

			function toMinutes(seconds) {
				var seconds = parseInt(seconds);
				var minutes = Math.floor(seconds / 60).toString();
				var remaining_seconds = seconds - minutes * 60;
				
				if ( remaining_seconds.toString().length == 1 ) {
					remaining_seconds = '0' + remaining_seconds.toString();
				}
				else {
					remaining_seconds = remaining_seconds.toString();
				}
				return minutes + ':' + remaining_seconds
			}

			function addGameInfo(obj) {
				
				console.log('gameobj');
				console.log(obj);
				$('#top_player_' + obj.game_num).html(obj[obj.top_player + '_name']);
				$('#bottom_player_' + obj.game_num).html(obj[getBottomPlayer(obj) + '_name']);
				$('#top_time_' + obj.game_num).html(toMinutes(obj[obj.top_player + '_clock']));
				$('#bottom_time_' + obj.game_num).html(toMinutes(obj[getBottomPlayer(obj) + '_clock']));
			}			

            function login () {
                socket.emit('login', [$('#login').val(), $('#password').val()]);
            }
            var gamemap = new Map();
            var socket = io();
            
            socket.on("result", function(msg) {
                let ficsobj = window.PARSER.parse(msg);
                let showout = false;
                
                if (ficsobj.cmd_code) {
                    cmd_code = ficsobj.cmd_code;
                    if (ficsobj.end_reached) {
                        let lines = ficsobj.body.split('\n');

                        // games command result
                        if (ficsobj.cmd_code === 43) {
                            $('#lists').empty();
                            lines.forEach(x => {
                                if (x.replace(/[\s\n\t\r\x07]*/g,'')) {
                                    var gamenum = x.replace(/^\s+|\s+$/g, '').split(/\s+/)[0];
                                    $('<a href="#" style="text-decoration: none">'+x+'</a><br />').on({
                                        click: function() {
                                            socket.emit('command', '3 observe ' + gamenum); 
                                            console.log("3 observe " + gamenum); 
                                            return false;
                                        }
                                    }).appendTo($('#lists'))
                                }
                            });
                        // sought command result
                        } else if (ficsobj.cmd_code === 157) {
                            $('#lists').empty();
                            lines.forEach(x => {
                                if (x.replace(/[\s\n\t\r\x07]*/g,'')) {
                                    var gamenum = x.replace(/^\s+|\s+$/g, '').split(/\s+/)[0];
                                    $('<a href="#" style="text-decoration: none">'+x+'</a><br />').on({
                                        click: function() {
                                            //socket.emit('command', '4 play ' + gamenum); 
                                            console.log('4 play ' + gamenum); 
                                            return false;
                                        }
                                    }).appendTo($('#lists'))
                                }
                            });
                        // moves command result
                        } else if (ficsobj.cmd_code === 77) {
                            let movesobj = window.MOVESPARSER.parse(ficsobj.body);
                            let game = gamemap.get(movesobj.get("game_num").toString());
							game.top_player = 'b';
							var game_num = game.game_num;
							console.log('qweqwe');
							console.log(game);
							console.log('qweqwe');
                            game.setMoves(movesobj.get("moves"));
                            game.setMoveTimes(movesobj.get("movetimes"));
                            console.log(gamemap.get(movesobj.get("game_num").toString()).moves);


                            var observe_div_id = 'observe_' + game_num;
                            var wp_div_id = 'bottom_player_' + game_num;
                            var bp_div_id = 'top_player_' + game_num;
                            var board_div_id = 'board_' + game_num;
                            var ginfo_div_id = 'ginfo_' + game_num;
                            var top_time_div_id = 'top_time_' + game_num;
                            var bottom_time_div_id = 'bottom_time_' + game_num;
                            var moves_div_id = 'moves_' + game_num;
                            var controls_div_id = 'controls_' + game_num;
                            var flip_div_id = 'flip_' + game_num;



                            var observe_div = $('<div id="' + observe_div_id + '" class="clearfix observe"></div>');
                            var wp_div = $('<div id="' + wp_div_id + '" class="player_name"></div>');
                            var bp_div = $('<div id="' + bp_div_id + '" class="player_name"></div>');
                            var board_div = $('<div class="board_info_container"><div id="' + board_div_id + '" class="board"></div></div>');
                            var ginfo_div = $('<div class="game_info_container"><div id="' + ginfo_div_id + '" class="game_info"><div class="top_time" id="' + top_time_div_id + '"></div><div class="move_list clearfix" id="' + moves_div_id + '"></div><div class="bottom_time" id="' + bottom_time_div_id + '"></div></div><div id="' + controls_div_id + '" class="controls"><button type="button" id="' + flip_div_id + '">Flip</button></div></div>');


                            bp_div.appendTo(observe_div);
                            board_div.appendTo(observe_div);
                            ginfo_div.appendTo(observe_div);
                            wp_div.appendTo(observe_div);
                            observe_div.appendTo($('#games_div'));

                            $('#flip_' + game.game_num).click(function() {
                                game.top_player = getBottomPlayer(game);  
                                game.board.flip();
                                addGameInfo(game);
                            }); 
                            console.log('asdfasdfasdf');    
                            addGameInfo(game);

                            move_number = 1;

                            for (i=0; i < game.moves.length; i++) {
                                if (i % 2 == 0) {
                                    $('#moves_' + game.game_num).append('<div class="move_number" id="move_38_' + move_number.toString() + '">' + move_number.toString() + '</div><div class="move">' + game.moves[i] + '</div>');
                                }

                                else {
                                    $('#moves_' + game.game_num).append('<div class="move">' + game.moves[i] + '</div>');
                                    move_number += 1;
                                }

                            }


                            game.setBoard(new ChessBoard(board_div_id, {position: fenFromRanks(game.ranks)}));









                        // observe command result
                        } else if (ficsobj.cmd_code === 80) {
                            showout = true;
                            
                            console.log(ficsobj.s12);
                            
                            var game_num = ficsobj.s12.game_num.toString();
                            gamemap.set(game_num, new Game(ficsobj.s12));
                            

                			socket.emit('command', '8 moves ' + game_num);
                        } else {
                            showout = true;
                        }
                        
                    }
                } else {
                    showout = true;
                    if (ficsobj.style12) {
                        let game_num = ficsobj.s12.game_num.toString();
                        gamemap.get(game_num).board.move(ficsobj.s12.move_note);
                        addGameInfo(ficsobj.s12);
                        showout = false;
                    }
                }
                
                if (ficsobj.body.length && showout) 
                {
                    $('<pre>' + ficsobj.body + '</pre>').appendTo($('#shellout'));
                    $('#shellout').scrollTop($('#shellout').prop('scrollHeight'));
                }

                console.log('end on result');
            });

            function getGameInfoHTML(s12) {
                var info = [
                    'whose_move: ' + s12.whose_move, 
                    'game_num: ' + s12.game_num, 
                    'my_rel: ' + s12.my_rel, 
                    'dur: ' + s12.dur, 
                    'inc: ' + s12.inc, 
                    'w_mat: ' + s12.w_mat, 
                    'b_mat: ' + s12.b_mat, 
                    'w_clock: ' + s12.w_clock, 
                    'b_clock: ' + s12.b_clock, 
                    'move_num: ' + s12.move_num, 
                    'move_piece: ' + s12.move_piece, 
                    'move_note: ' + s12.move_note, 
                    'move_time: ' + s12.move_time, 
                    'move_note_short: ' + s12.move_note_short,
                    ]
                return '<pre>' + info.join('\n') + '</pre>';
            }


            socket.on("logged_in", function(msg) {
                $('#login_div').hide();
                $('#shellout').show();
                $('#shellin').show();
                $('#games').prop('disabled', false);
                $('#sought').prop('disabled', false);
            });


            function fenFromRanks(ranks) {
                var fen = '';
                for (let r=0; r<8; r++) {
                    let rank = ranks[r];
                    let empty_count = 0;
                    for (let s=0; s<8; s++) {
                        if (rank[s] === '-') {
                            empty_count++;
                            if (s === 7) {
                                fen = fen + empty_count.toString();
                            }
                        } else {
                            if (empty_count) {
                                fen = fen + empty_count.toString();
                            }
                            fen = fen + rank[s];
                            empty_count = 0;
                        }
                    }
                    if (r != 7) { fen = fen + '/'; }
                }
                return fen;
            }
        })
    </script>
</head>
<body>
    <div id="login_div">
        login: <input type="text" name="login" id="login" />
        <br/>
        password: <input type="password" name="password" id="password" />
        <br/>
        <input type="button" name="submit" value="login" id="login_button" />
        <br/>
    </div>
    <div style="clear:both">
        <div id="shellout" style="height: 30%; overflow: auto; white-space:nowrap;padding : 0 18 0 3px"></div>
        <div id="shellin">
            shell: <input type="text" name="shell" id="shell" size="50"/>
        </div>
    </div>
    <div style="clear:both">
        <div id="games_div" style="float:left; width: auto">
        </div>
        <div style="float:right">
            <input type="button" name="games" value="Games in progress" id="games" />
            <input type="button" name="sought" value="Games available" id="sought" />
            <div id="lists" style="height: 100%; overflow: auto; white-space:nowrap;padding : 0 18 0 3px"></div>
        </div>
    </div>

</body>
