<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
    <script src="chessboardjs-0.3.0/js/chessboard-0.3.0.min.js"></script>
    <script src="chess.js-master/chess.min.js"></script>
    <script src="js/ficsparser.js"></script>
    <link rel="stylesheet" href="chessboardjs-0.3.0/css/chessboard-0.3.0.min.css" />
    <script>
        $(document).ready(function(){
                /*
                   <12> r-bq-rk- p-p-nppp --pb---- ---p---- ---P---- --N-BN-- PPP--PPP R--QK--R W -1 1 1 0 0 2 304 AFRF InkaGrings 0 1 3 35 35 68 68 9 o-o (0:01) O-O 0 1 112
                   fics% 
                   <12> r-bq-rk- p-p-nppp --pb---- ---p---- ---P---- --N-BN-- PPP--PPP R--Q-RK- B -1 0 0 0 0 3 304 AFRF InkaGrings 0 1 3 35 35 69 68 9 o-o (0:02) O-O 0 1 111
                   */
            //#define BLK_GAMES 43
            //#define BLK_OBSERVE 80
            //#define BLK_UNOBSERVE 138
            //#define BLK_SOUGHT 157

            /*
            var login = function() {
                socket.emit('login', [$('#login').val(), $('#password').val()]);
            }
            $('#login').keypress(function(e) {if (e.which == 13) login()});
            $('#password').keypress(function(e) {if (e.which == 13) login()});
            $('#login_button').on('click', function() { login() });
            */

            $('#games').prop('disabled', true);
            $('#sought').prop('disabled', true);
            $('#finger').prop('disabled', true);


            $('#login_button').on('click', function () {
                function fenFromRanks(ranks) {
                    var fen = '';
                    for (let r=0; r<8; r++) {
                        let rank = ranks[r];
                        let empty_count = 0;
                        for (let s=0; s<8; s++) {
                            if (rank[s] === '-') {
                                empty_count++;
                                if (s === 7) {
                                    fen = fen + empty_count.toString();
                                }
                            } else {
                                if (empty_count) {
                                    fen = fen + empty_count.toString();
                                }
                                fen = fen + rank[s];
                                empty_count = 0;
                            }
                        }
                        if (r != 7) { fen = fen + '/'; }
                    }
                    return fen;
                }
                var boardmap = new Map();
                var socket = io();
                
                socket.on("result", function(msg) {
                    var ficsobj = window.PARSER.parse(msg);
                    
                    if (ficsobj.cmd_code) {
                        cmd_code = ficsobj.cmd_code;
                        if (ficsobj.end_reached) {
                            let lines = ficsobj.body.split('\n');
                            if (ficsobj.cmd_code === 43) {
                                $('#cmdinfo').empty();
                                lines.forEach(x => {
                                    if (x.replace(/[\s\n\t\r\x07]*/g,'')) {
                                        var gamenum = x.replace(/^\s+|\s+$/g, '').split(/\s+/)[0];
                                        $('<a href="#" style="text-decoration: none">'+x+'</a><br />').on({
                                            click: function() {
                                                socket.emit('command', '3 observe ' + gamenum); 
                                                console.log('3 observe ' + gamenum); 
                                                return false;
                                            }
                                        }).appendTo($('#cmdinfo'))
                                    }
                                });
                            } else if (ficsobj.cmd_code === 157) {
                                $('#cmdinfo').empty();
                                lines.forEach(x => {
                                    if (x.replace(/[\s\n\t\r\x07]*/g,'')) {
                                        var gamenum = x.replace(/^\s+|\s+$/g, '').split(/\s+/)[0];
                                        $('<a href="#" style="text-decoration: none">'+x+'</a><br />').on({
                                            click: function() {
                                                //socket.emit('command', '4 play ' + gamenum); 
                                                console.log('4 play ' + gamenum); 
                                                return false;
                                            }
                                        }).appendTo($('#cmdinfo'))
                                    }
                                });
                            } else if (ficsobj.cmd_code === 80) {
                                var div_id_str = 'observe_' + ficsobj.s12.game_num.toString();
                                $('<div id="' + div_id_str + '" style="width: 300px; float:left"></div>').appendTo($('#games_div'));

                                var board = new ChessBoard(div_id_str, {position: fenFromRanks(ficsobj.s12.ranks)});
                                boardmap.set(div_id_str, board);

                                $('<pre>' + ficsobj.style12 + '</a>').appendTo($('#style12'))
                                $('<pre>' + fenFromRanks(ficsobj.s12.ranks) + '</a>').appendTo($('#style12'));
                            }
                        }
                    } else {
                        if (ficsobj.style12) {
                            boardmap.get('observe_'+ficsobj.s12.game_num.toString()).move(ficsobj.s12.move_note);
                            $('<pre>' + ficsobj.style12 + '</a>').appendTo($('#style12'))
                            $('<pre>' + fenFromRanks(ficsobj.s12.ranks) + '</a>').appendTo($('#style12'));
                        } else {
                            $('<pre>' + ficsobj.body + '</a>').appendTo($('#style12'));
                        }
                    }
                    console.log('end on result');
                });


                socket.on("logged_in", function(msg) {
                    $('#games').prop('disabled', false);
                    $('#sought').prop('disabled', false);
                    $('#finger').prop('disabled', false);
                    $('#login_button').prop('disabled', true);
                });

                socket.emit('login', [$('#login').val(), $('#password').val()]);


                $('#games').on('click', function(e) {
                    socket.emit('command', '1 games');
                });

                $('#sought').on('click', function(e) {
                    socket.emit('command', '2 sought');
                });

                $('#finger').on('click', function(e) {
                    socket.emit('command', '4 finger');
                });

                //$('#shell_button').on('click', function(e) {
                //    socket.emit('command', $('#shell').val());
                //});
            });
        })
    </script>
</head>
<body>
    <!--
    <div class="login_div">
        login: <input type="text" name="login" id="login" />
        <br/>
        password: <input type="password" name="password" id="password" />
        <br/>
        <input type="button" name="submit" value="login" id="login_button" />
        <br/>
    </div>
    -->
    <div style="clear:both">
        <div id="style12" style="height: 30%; overflow: auto; white-space:nowrap;padding : 0 18 0 3px"></div>
    </div>
    <div style="clear:both">
        <div id="games_div" style="float:left; width: auto">
        </div>
        <div style="float:right">
            <!--
            shell: <input type="text" name="shell" id="shell" size="50"/>
            <input type="button" name="submit" value="send command" id="shell_button" />
            -->
            <input type="button" name="games" value="Games in progress" id="games" />
            <input type="button" name="sought" value="Games available" id="sought" />
            <input type="button" name="finger" value="finger" id="finger" />
            <input type="button" name="submit" value="login" id="login_button" />
            <div id="cmdinfo" style="height: 100%; overflow: auto; white-space:nowrap;padding : 0 18 0 3px"></div>
        </div>
    </div>

</body>
